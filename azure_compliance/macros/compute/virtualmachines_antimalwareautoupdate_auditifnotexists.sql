{% macro compute_virtualmachines_antimalwareautoupdate_auditifnotexists(framework, check_id) %}
WITH malware_agent_installed_vm AS (
    SELECT DISTINCT
    _cq_id
    FROM azure_compute_virtual_machines, jsonb_array_elements(resources) AS res
    WHERE
        res->>'publisher' = 'Microsoft.Azure.Security'
        AND res->>'type' = 'IaaSAntimalware'
        AND (res->>'autoUpgradeMinorVersion')::boolean IS TRUE
)

SELECT
  azure_compute_virtual_machines._cq_sync_time As sync_time,
  '{{framework}}' As framework,
  '{{check_id}}' As check_id,
  'Microsoft Antimalware for Azure should be configured to automatically update protection signatures',
  azure_compute_virtual_machines.subscription_id,
  azure_compute_virtual_machines.id,
  case
    when azure_compute_virtual_machines.properties -> 'storageProfile' -> 'osDisk' ->> 'osType' = 'Windows'
	    AND malware_agent_installed_vm._cq_id IS NULL
    then 'fail'
    else 'pass'
  end
FROM
	azure_compute_virtual_machines
	LEFT JOIN malware_agent_installed_vm ON malware_agent_installed_vm._cq_id = azure_compute_virtual_machines._cq_id
{% endmacro %}